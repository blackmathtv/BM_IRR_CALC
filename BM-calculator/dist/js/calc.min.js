/*! blackmath-calculator v1.0.0 | (c) 2020  | ISC License | git+https://github.com/madhat5/BM-calculator.git */
!(function(t){t(document).ready((function(){const e={$completeNotReset:!1,$cashFlows:[],$cashFlowsPos:[],$cashFlowsPosStorage:[],$cashFlowInput:null,$cashFlowList:null,$cashFlowAddBtn:null,$cashFlowRemoveBtn:null,$cashFlowsCalculated:[],$cashFlowsCalculatedPos:[],$cashFlowsTotals:[],$maxCashFlow:null,$rateGrowth:null,$rateDecay:null,$resetBtn:null,$runAgainBtn:null,$calcBtn:null,$chartObj:null,$stackedChart:null,$stackedData:[],$stackedDataStorage:[],$activeStep:1,init:function(){console.log("calc init"),e.$cashFlowInput=t("#cash-flow-input"),e.$cashFlowList=t("#cash-flow-list"),e.$cashFlowAddBtn=t("#cash-flow-add-btn"),e.$calcBtn=t("#calc-btn"),e.$resetBtn=t("#app-reset-btn"),e.$runAgainBtn=t("#run_again-btn"),e.$slider=t(".range-slider"),e.$range=t(".range-slider__range"),e.$growthValue=t(".range-slider__value"),e.$decayValue=t(".decay-rate__value"),e.$resList=t("#calc-res"),e.$chart=t("#chart-main"),e.$chartControls=t("#chart-controls"),e.$progressBar=t("#step-progress-bar"),e.$progressBarOriginalState=t("#step-progress-bar").clone(),e.$sliderPopover=t(".slider_tutorial"),e.$resultsPopover=t(".results_tutorial"),e.$stepMessage=t("#step-message"),e.$prevBtn=t("#prev-btn"),e.$nextBtn=t("#next-btn"),e.$dollarSVG=t("#dollar-svg"),e.$stepMessages=["Multiply each year by it's discount factor","Sum together all positive and negative cash flows.","Subtract negative cash flows from positive cash flows."],e.$timeouts=[],e.$cashFlowInput.focus(),e.$cashFlowAddBtn.click((function(a){a.preventDefault(),a.stopPropagation();const s=t(e.$cashFlowInput).val();e.addCashFlow(s)})),e.$cashFlowList.click((function(t){const a=t.target;if(a.classList.contains("remove-cash-flow")){const t=a.parentElement;e.removeCashFlow(t)}})),e.$cashFlowInput.keypress((function(a){if(13===(event.keyCode?event.keyCode:event.which)){const a=t(e.$cashFlowInput).val();e.addCashFlow(a)}})),e.$slider.each((function(){e.$growthValue.each((function(){e.initialRates()})),e.$range.on("input",(function(){e.currentRates(),console.log("slider triggered"),t(e.$calcBtn).hasClass("calc-btn--active")||(t(e.$calcBtn).addClass("calc-btn--active"),t(e.$calcBtn).removeAttr("disabled"))}))})),e.$sliderPopover.popover(),e.$resultsPopover.popover(),e.$calcBtn.click((function(t){t.stopPropagation(),t.preventDefault(),e.step_1(),e.$timeouts.push(setTimeout((function(){e.step_2()}),3e3)),e.$timeouts.push(setTimeout((function(){e.step_3()}),6e3)),e.$timeouts.push(setTimeout((function(){e.step_4()}),6300)),e.$timeouts.push(setTimeout((function(){e.step_5()}),9500))})),e.$prevBtn.click((function(a){a.preventDefault(),a.stopPropagation();for(var s=0;s<e.$timeouts.length;s++)clearTimeout(e.$timeouts[s]);if(2==e.$activeStep)e.$activeStep=1,e.$stepMessage.html(e.$stepMessages[0]),e.$prevBtn.attr("disabled","disabled"),e.$chartObj.series[0].update({data:e.$cashFlowsPosStorage,softMax:Math.max(e.$cashFlowsPosStorage)});else if(3==e.$activeStep||4==e.$activeStep){var o=t(t(".highcharts-tracker")[0]).children();t(o).css("transform","scaleY(1)"),t(t(".highcharts-container svg .highcharts-series-group g")[0]).attr("style","transform: translateY(0)"),t(e.$chart).removeClass("step-3"),e.step_2(),console.log("second block")}else 5==e.$activeStep&&(e.$activeStep=4,e.$nextBtn.removeAttr("disabled"),t("#hidden-final-chart .chart-final-message").css("display","none"),t("#hidden-final-chart .highcharts-container").css("transform","translateY(0)"),console.log("active step 5 thing"),console.log(e.$stackedDataStorage),e.$stackedChart.series[0].update({data:e.$stackedDataStorage}),t("#overflow-hide").css({height:"420px",overflow:"hidden",transition:"all .3s ease-in-out"}));e.$progressBar.attr("data-active-step",e.$activeStep)})),e.$nextBtn.click((function(t){t.preventDefault(),t.stopPropagation();for(var a=0;a<e.$timeouts.length;a++)clearTimeout(e.$timeouts[a]);1==e.$activeStep?e.step_2():2==e.$activeStep?(e.step_3(),setTimeout((function(){e.step_4()}),300)):4==e.$activeStep&&e.step_5()})),e.$runAgainBtn.click((function(a){a.stopPropagation(),a.preventDefault(),e.runAgain(),e.step_1(),setTimeout((function(){e.step_2()}),3e3),setTimeout((function(){t("#hidden-final-chart").removeClass("runAgainTransform"),e.step_3()}),5e3),setTimeout((function(){e.step_4()}),5300),setTimeout((function(){e.step_5()}),8500),t("#overflow-hide").css({height:"420px",overflow:"hidden",transition:"all .3s ease-in-out"})})),e.$resetBtn.click((function(t){t.preventDefault(),t.stopPropagation(),e.resetApp()}))},step_1:function(){if(e.$chartControls.addClass("chart-controls--active"),e.$stepMessage.html(e.$stepMessages[0]),e.$prevBtn.attr("disabled","disabled"),e.$progressBar.attr("data-active-step",e.$activeStep),t("#bar-style")){var a=document.createElement("style");a.id="bar-style",a.type="text/css",document.getElementsByTagName("head")[0].appendChild(a)}else t("#bar-style").remove();e.$maxCashFlow=e.$cashFlowsPos.reduce((function(t,e){return Math.max(t,e)})),e.$cashFlows.forEach((function(t,e){if(t<0){var s="#chart-container .highcharts-series rect:nth-child("+(e+1)+") { fill: #E43B3F; }";a.appendChild(document.createTextNode(s))}})),e.decayCashFlow(e.$rateDecay),e.totalsCashFlows(),t(e.$chart).addClass("chart--active"),Highcharts.setOptions({lang:{thousandsSep:","}}),e.$chartObj=Highcharts.chart("chart-container",{chart:{type:"column"},title:{text:""},tooltip:{headerFormat:"",pointFormat:'<strong style="font-size:10px">{point.y}</strong>',useHTML:!0},yAxis:{visible:!1,softMax:e.$maxCashFlow},xAxis:{visible:!1},plotOptions:{column:{groupPadding:0,borderWidth:1}},series:[{showInLegend:!1,color:"#4F5366",negativeColor:"#E43B3F",data:e.$cashFlowsPos,threshold:null}]});var s=e.$cashFlowsTotals[0],o=e.$cashFlowsTotals[1];"NaN"!==s&&(e.$stackedData.push(s),e.$stackedDataStorage.push(s)),"NaN"!==o&&(e.$stackedData.push(o),e.$stackedDataStorage.push(o)),e.$stackedChart=Highcharts.chart("hidden-final-chart",{chart:{type:"column"},title:{text:""},tooltip:{headerFormat:"",pointFormat:'<strong style="font-size:10px">{point.y}</strong>',useHTML:!0},yAxis:{visible:!1,softMin:e.$maxCashFlow},xAxis:{visible:!1},plotOptions:{column:{groupPadding:0,borderWidth:1,stacking:"normal"}},series:[{showInLegend:!1,color:"#4F5366",negativeColor:"#E43B3F",data:e.$stackedData,threshold:0}]})},step_2:function(){e.$stepMessage.html(e.$stepMessages[1]),e.$activeStep=2,e.$progressBar.attr("data-active-step",e.$activeStep),e.$prevBtn.removeAttr("disabled"),e.$chartObj.series[0].update({data:e.$cashFlowsCalculatedPos})},step_3:function(){var a=t(t(".highcharts-tracker")[0]).children();e.$prevBtn.removeAttr("disabled"),e.$activeStep=3,e.$progressBar.attr("data-active-step",e.$activeStep),t(a).attr("style","transform: scaleY(0); transform-origin: bottom;"),setTimeout((function(){t(t(".highcharts-container svg .highcharts-series-group g")[0]).attr("style","transform: translateY(100%)")}),250)},step_4:function(){e.$stepMessage.html(e.$stepMessages[2]),e.$prevBtn.removeAttr("disabled"),e.$nextBtn.removeAttr("disabled"),e.$activeStep=4,e.$progressBar.attr("data-active-step",e.$activeStep),t(e.$chart).addClass("step-3");var a=t(t(".highcharts-tracker")[1]).children()[1].getAttribute("y"),s=document.createElementNS("http://www.w3.org/2000/svg","path"),o=document.createElementNS("http://www.w3.org/2000/svg","path");s.setAttribute("id","pos-wave"),o.setAttribute("id","neg-wave"),o.setAttribute("style","transform: translateY("+Math.round(a-60)+"px);"),t(t("#hidden-final-chart .highcharts-series-group g")[0]).prepend(s),t(t("#hidden-final-chart .highcharts-series-group g")[0]).append(o)},step_5:function(){const a=e.$cashFlowsTotals[2].toFixed(2),s='<div class="chart-final-message" id="chart-final-message"><p class="final-header">Average NPV per year</p><span id="final-value">$'+e.addCommas(a)+"</span>";let o;finalMessageAddOn='<p class="final-message" id="final-message">You\'ve found the IRR!</p></div>',o=0===a?s+finalMessageAddOn:s,t(e.$resetBtn).removeAttr("disabled"),t(e.$resetBtn).addClass("reset-btn--active"),e.$runAgainBtn.removeClass("redo-btn-hide"),e.$runAgainBtn.addClass("redo-btn--active"),e.$nextBtn.attr("disabled","disabled"),e.$activeStep=5,e.$progressBar.attr("data-active-step",e.$activeStep),e.$stackedChart.series[0].update({data:[a,a]}),setTimeout((function(){const e=t("#overflow-hide").height(),a=t("#hidden-final-chart").height(),s=e+a/3;console.log("overflowHeight: "+e),console.log("finalChartHeight: "+a),console.log("height should be: "+s+"px"),t("#overflow-hide").css({height:s+"px",overflow:"visible",transition:"all .3s ease-in-out"}),t("#hidden-final-chart .highcharts-container").css({transform:"translateY(130px)",transition:"all .3s ease-in-out"})}),800),setTimeout((function(){t("#hidden-final-chart").prepend(o),setTimeout((function(){t("#chart-final-message").css("opacity","1")}),200)}),1300),e.$completeNotReset||e.displayRes(e.$rateGrowth,e.addCommas(a)),e.$completeNotReset=!0},addCommas:function(t){return t.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")},addCashFlow:function(a){const s=a.replace(",",""),o=new Number(s).toFixed(2),r=new Number(o);if("NaN"===o)alert("Please enter a valid number");else{const a="<li>$"+e.addCommas(o)+'<a href="#" class="remove-cash-flow"></a>';t(e.$cashFlowList).append(a),e.$cashFlows.push(r.valueOf()),e.$cashFlowsPos.push(Math.abs(r.valueOf())),e.$cashFlowsPosStorage.push(Math.abs(r.valueOf())),e.$cashFlowInput.val(""),t(e.$cashFlowList).scrollTop(t(e.$cashFlowList)[0].scrollHeight),e.$cashFlowInput.focus()}},removeCashFlow:function(a){const s=t(a).index();e.$cashFlows.splice(s,1),e.$cashFlowsPos.splice(s,1),e.$cashFlowsPosStorage.splice(s,1),a.remove(),e.$cashFlowInput.focus()},initialRates:function(){var t,a,s;t=e.$growthValue.next().attr("value"),e.$growthValue.html(t+"%"),e.$rateGrowth=t/100,a=100*(1-1/(1+e.$rateGrowth)),s=Math.round(a).toFixed(2),e.$rateDecay=s/100,e.$decayValue.html((1-e.$rateDecay).toFixed(2))},currentRates:function(){var a,s,o;a=t("input[type=range]").val(),e.$growthValue.text(a+"%"),e.$rateGrowth=a/100,s=100*(1-1/(1+e.$rateGrowth)),o=Math.round(s).toFixed(2),e.$rateDecay=o/100,e.$decayValue.html((1-e.$rateDecay).toFixed(2))},decayCashFlow:function(t){var a,s,o;for(a=0;a<e.$cashFlows.length;a++)0==a?(e.$cashFlowsCalculated.push(e.$cashFlows[a]),e.$cashFlowsCalculatedPos.push(e.$cashFlows[a])):(s=e.$cashFlows[a]*Math.pow(1-t,a),o=Number(s.toFixed(2)),e.$cashFlowsCalculated.push(o),e.$cashFlowsCalculatedPos.push(Math.abs(o)))},totalsCashFlows:function(){var t,a,s,o,r,l,n,c,i=[],h=[];for(t=0;t<e.$cashFlowsCalculated.length;t++)1==Math.sign(e.$cashFlowsCalculated[t])?(a=e.$cashFlowsCalculated[t],i.push(a)):-1==Math.sign(e.$cashFlowsCalculated[t])?(s=e.$cashFlowsCalculated[t],h.push(s)):console.log("0 or NaN entered");const d=t=>t.reduce((t,e)=>t+e,0);0==i.length||void 0===i?(r=0,e.$cashFlowsTotals.push(r)):(o=Number(d(i).toFixed(2)),r=Number((o/i.length).toFixed(2)),e.$cashFlowsTotals.push(r)),0==h.length||void 0===h?(n=0,e.$cashFlowsTotals.push(n)):(l=Number(d(h).toFixed(2)),n=Number((l/h.length).toFixed(2)),e.$cashFlowsTotals.push(n)),c=function(t,e){return Math.abs(t)>Math.abs(e)?Math.abs(t)-Math.abs(e):Math.abs(e)>Math.abs(t)?Math.abs(e)+Math.abs(t):void 0},e.$cashFlowsTotals.push(Number(c(r,n).toFixed(2)))},displayRes:function(t,a){e.$resList.append('<li><span class="cashflow-list-left">'+(100*t).toFixed(0)+'%</span> &nbsp;<span class="cashflow-list-right">$'+a+"</span></li>")},resetApp:function(){location.reload()},runAgain:function(){e.$completeNotReset=!1,t("#step-progress-bar").replaceWith(e.$progressBarOriginalState),t("#step-progress-bar").replaceWith(e.$progressBar),t("#hidden-final-chart").addClass("runAgainTransform"),e.$cashFlowsCalculated=[],e.$cashFlowsCalculatedPos=[],e.$cashFlowsTotals=[],e.$stackedData=[],e.$chartObj={},e.$stackedChart={},e.$stackedData=[],e.$stackedDataStorage=[],e.$activeStep=1}};e.init()}))})(jQuery);